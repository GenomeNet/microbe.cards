{% extends "jsonl_viewer/base.html" %}
{% load custom_filters %}

{% block title %}{{ microbe.binomial_name }}{% endblock %}

{% block extra_head %}
<style>
    /* Existing Styles */
    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }
    .warning-message svg {
        margin-right: 10px;
    }
    .full-width-section {
        width: 100%;
        margin-top: 20px;
    }

    /* Improved Table Styles */
    .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
        font-family: Arial, sans-serif;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    tr:hover {
        background-color: #f9f9f9;
    }
    .tooltip {
        position: relative;
        cursor: pointer;
        color: #007BFF;
    }
    .tooltip .tooltiptext {
        visibility: hidden;
        width: 220px;
        background-color: #555;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%; /* Position above the text */
        left: 50%;
        margin-left: -110px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
    .ground-truth-column {
        /* Existing styles */
    }
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        th, td {
            padding: 8px 10px;
        }
        .tooltip .tooltiptext {
            width: 180px;
            margin-left: -90px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="main-content">
        <h1>{{ microbe.binomial_name }}</h1>
        {% with clean_names=microbe.alternative_names|clean_alternative_names %}
            {% if clean_names %}
                <h3>{{ clean_names }}</h3>
            {% endif %}
        {% endwith %}

        <!-- Warning Message -->
        <div class="warning-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#856404" viewBox="0 0 24 24">
                <path d="M1 21h22L12 2 1 21zm13-2h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
            <div>
                <strong>Note:</strong> These predictions are generated by language models and might be incorrect. Please refer to individual model performance metrics before making any critical decisions.
            </div>
        </div>

        <!-- Phenotype Summary -->
        <div class="section">
            <h2>Phenotype Summary</h2>
            <p>Ground truth annotations for this microbe: {{ ground_truth_count }}</p>
            <p>Additional LLM-generated phenotypes for this microbe: {{ additional_predictions_count }}</p>
            <div class="table-description">
                <p>The table below shows the phenotypes and predictions. Cell colors indicate the class of the value, and borders indicate correctness if ground truth data is available (green for correct, red for incorrect).</p>
            </div>
        </div>
    </div>

    <div class="infobox">
        <h2>Taxonomy</h2>
        <p><strong>Superkingdom:</strong> {{ microbe.taxonomy.superkingdom }}</p>
        <p><strong>Phylum:</strong> {{ microbe.taxonomy.phylum }}</p>
        <p><strong>Class:</strong> {{ microbe.taxonomy.class_name }}</p>
        <p><strong>Order:</strong> {{ microbe.taxonomy.order }}</p>
        <p><strong>Family:</strong> {{ microbe.taxonomy.family }}</p>
        <p><strong>Genus:</strong> {{ microbe.taxonomy.genus }}</p>
        <p><strong>Species:</strong> {{ microbe.taxonomy.species }}</p>

        <h2>NCBI ID</h2>
        <p>{{ microbe.ncbi_id }}</p>

        <h2>Genome Info</h2>
        <p><strong>FTP Path:</strong><br>{{ microbe.ftp_path|default:"N/A" }}</p>
        <p><strong>FASTA File:</strong><br>{{ microbe.fasta_file|default:"N/A" }}</p>
    </div>
</div>

<!-- Phenotypes and Predictions Table -->
<div class="section full-width-section">
    <h2>Phenotypes and Predictions</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Phenotype</th>
                    <th class="ground-truth-column">Ground Truth</th>
                    {% for prediction in phenotype_data.0.predictions %}
                        <th>
                            <a href="{% url 'model_detail' model_name=prediction.model|urlencode %}">
                                {{ prediction.model }}
                            </a>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for data in phenotype_data %}
                    {% if data.phenotype_definition.name != "Member of WA subset" %}
                        <tr>
                            <td>
                                <a href="{% url 'model_ranking' %}#{{ data.phenotype_definition.name|slugify }}">
                                    {{ data.phenotype_definition.name }}
                                </a>
                            </td>
                            <td class="ground-truth-column" style="
                                {% if data.ground_truth %}
                                    background-color: {{ data.ground_truth|consistent_color }};
                                {% else %}
                                    background-color: #E0E0E0; /* Grey color */
                                {% endif %}
                            ">
                                {% if data.ground_truth %}
                                    {{ data.ground_truth|cut:'"'|lower }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            {% for prediction in data.predictions %}
                            <td style="
                                {% if prediction.predicted_value %}
                                    background-color: {{ prediction.predicted_value|consistent_color }};
                                {% else %}
                                    background-color: #E0E0E0; /* Grey for 'N/A' */
                                {% endif %}
                            ">
                                {% if prediction.predicted_value %}
                                    <span class="tooltip" style="font-family: monospace;">
                                        {{ prediction.predicted_value|cut:'"'|lower }}
                                        {% if data.ground_truth %}
                                            {% if prediction.predicted_value|normalize_value == data.ground_truth|normalize_value %}
                                                <span style="margin-left: 5px; color: green;">✓</span>
                                            {% else %}
                                                <span style="margin-left: 5px; color: red;">✗</span>
                                            {% endif %}
                                        {% endif %}
                                        {% if prediction.model_performance %}
                                            <span class="tooltiptext">
                                                <strong>Performance Metrics:</strong><br>
                                                Balanced Accuracy: {{ prediction.model_performance.balanced_accuracy|floatformat:3 }}<br>
                                                Precision: {{ prediction.model_performance.precision|floatformat:3 }}<br>
                                                Sample Size: {{ prediction.model_performance.sample_size }}
                                            </span>
                                        {% else %}
                                            <span class="tooltiptext">No performance data available</span>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                    {% endif %}
                {% empty %}
                    <tr>
                        <td colspan="{{ 2|add:phenotype_data.0.predictions|length }}">No phenotypes available</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<p><a href="{% url 'index' %}">Back to Microbe List</a></p>
{% endblock %}