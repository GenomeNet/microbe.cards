{% extends "jsonl_viewer/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ microbe.binomial_name }}{% endblock %}


{% block after_header %}
    <!-- Full-Width Wrapper for the Warning Banner -->
    <div class="full-width-banner">
        <div class="warning-message-banner">
            <div style="display: flex; align-items: center;">
             
                <div>
                    Disclaimer: The information provided here is generated by AI models and is for informational purposes only. It may contain inaccuracies or errors. This content is an attempt to synchronize information available from different databases and predictive models. It should not be used for medical diagnosis, treatment, or any health-related decision-making. We expressly disclaim all liability for reliance on this information. Users are strongly advised to consult professional sources and refer to individual model performance metrics for accuracy assessment. Use of this information is at your own risk.
                </div>
            </div>
            <!-- Report Error Button -->
            <button type="button" class="report-error-button" data-bs-toggle="modal" data-bs-target="#reportErrorModal">
                Report Error
            </button>
        </div>
    </div>
{% endblock %}

{% block content %}
    <!-- Report Error Modal -->
    <div class="modal fade" id="reportErrorModal" tabindex="-1" aria-labelledby="reportErrorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{% url 'report_error' %}">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="reportErrorModalLabel">Report an Error</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="errorDescription" class="form-label">Describe the Error</label>
                <textarea class="form-control" id="errorDescription" name="description" rows="3" required></textarea>
              </div>
              <!-- Hidden Fields -->
              <input type="hidden" name="microbe_id" value="{{ microbe.id }}">
              <input type="hidden" name="current_page" value="{{ request.path }}">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">Submit Report</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="content-wrapper">
        <div class="main-content">
            <h1 style="display: inline-flex; align-items: center;">
                <i>{{ microbe.binomial_name }}</i>
                <span style="margin-left: 10px; position: relative;">
                    {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'toggle_star' microbe.id %}" style="margin-left: 10px; display: inline-block;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-watch">
                                <i class="fas fa-star"></i>
                                {% if microbe in user.profile.starred_microbes.all %}
                                    Card is starred
                                {% else %}
                                    Star this Card to get notified for updates
                                {% endif %}
                                <span class="watch-count">{{ watch_count }}</span>
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'login' %}" style="margin-left: 10px; color: grey; text-decoration: none; position: relative;" class="btn btn-watch">
                            <i class="fas fa-star"></i> Star this Card to get notified for updates
                            <span class="watch-count">{{ watch_count }}</span>
                        </a>
                    {% endif %}
                </span>
            </h1>
            
     
            

            {% with clean_names=microbe.alternative_names|clean_alternative_names %}
                {% if clean_names %}
                    <h3>{{ clean_names }}</h3>
                {% endif %}
            {% endwith %}
            
           

            <!-- General Information with Tabs -->
            {% with general_info=None %}
                {% if descriptions_by_type %}
                    {% for type, descriptions in descriptions_by_type.items %}
                        {% if type == "General Information" %}
                            {% with general_info=descriptions %}
                                <div class="section full-width-section">
                                    <h2>General Information</h2>
                                    
                                    {% if general_info|length > 1 %}
                                        <!-- Tabs for multiple models -->
                                        <div class="tab">
                                            {% for desc in general_info %}
                                                <button class="tablinks {% if forloop.first %}active{% endif %}" onclick="openGeneralInfoTab(event, 'GeneralInfo-{{ forloop.counter }}')">{{ desc.model }}</button>
                                            {% endfor %}
                                        </div>
                                        {% for desc in general_info %}
                                            <div id="GeneralInfo-{{ forloop.counter }}" class="tabcontent {% if forloop.first %}active{% endif %}">
                                                <p>{{ desc.description|markdownify }}</p>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Single description without tabs -->
                                        <div class="description-header">
                                            <h2>General Information</h2>
                                            <span class="model-name">Source: {{ general_info.0.model }}</span>
                                        </div>
                                        <hr class="header-divider">
                                        <p>{{ general_info.0.description|markdownify }}</p>
                                    {% endif %}
                                </div>
                            {% endwith %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Removed Phenotype Summary Section -->

        </div>

        <div class="infobox">
            <h2>Access Statistics</h2>
            <div class="daily-access-line" style="width: 100%; max-width: 600px; margin: 0 auto 10px auto;">
                <canvas id="accessChart" height="60"></canvas>
            </div>

            <h2>Taxonomy</h2>
            <p><strong>Superkingdom:</strong> {{ microbe.taxonomy.superkingdom }}</p>
            <p><strong>Phylum:</strong> {{ microbe.taxonomy.phylum }}</p>
            <p><strong>Class:</strong> {{ microbe.taxonomy.class_name }}</p>
            <p><strong>Order:</strong> {{ microbe.taxonomy.order }}</p>
            <p><strong>Family:</strong> {{ microbe.taxonomy.family }}</p>
            <p><strong>Genus:</strong> {{ microbe.taxonomy.genus }}</p>
            <p><strong>Species:</strong> {{ microbe.taxonomy.species }}</p>

            <h2>NCBI ID</h2>
            <p>
                <a href="https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id={{ microbe.ncbi_id }}" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; text-decoration: none; color: inherit;">
                    {{ microbe.ncbi_id }}
                    
                </a>
            </p>

            <h2>Genome Info</h2>
            <p><strong>FTP Path:</strong><br>{% if microbe.ftp_path %}<a href="ftp://{{ microbe.ftp_path }}" target="_blank">{{ microbe.ftp_path }}</a>{% else %}<span class="na-cell">N/A</span>{% endif %}</p>
            <p><strong>File for sequence-based predictions:</strong><br>{{ microbe.fasta_file|default:"<span class='na-cell'>N/A</span>"|safe }}</p>

        </div>
    </div>

    <!-- Render the rest of the descriptions -->
    <div class="section full-width-section">
        <h2>Descriptions</h2>
        {% if descriptions_by_type %}
        {% for type, descriptions in descriptions_by_type.items %}
            {% if type != "General Information" and descriptions %}
            {% if type == "Clinical Implications and Relevance" and not user.is_authenticated %}
            <div class="description-type-section">
                <div class="description-header">
                    <h3>{{ type|capfirst }}</h3>
                </div>
                <hr class="header-divider">
                <div class="restricted-content">
                    <div class="skeleton-lines">
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                    </div>
                    <div class="login-prompt">
                        <a href="{% url 'login' %}" class="login-link">This content has been automatically flagged for potential dual-use capability. Please log in with a researcher account to access this information.</a>
                    </div>
                </div>
            </div>
        {% else %}
                    <div class="description-type-section">
                        {% if descriptions|length == 1 %}
                            <div class="description-header">
                                <h3>{{ type|capfirst }}</h3>
                                <span class="model-name">Source: {{ descriptions.0.model }}</span>
                            </div>
                            <hr class="header-divider">
                            <p>{{ descriptions.0.description|markdownify }}</p>
                        {% else %}
                            <div class="description-header">
                                <h3>{{ type|capfirst }}</h3>
                            </div>
                            <hr class="header-divider">
                            <!-- Tabs for multiple models -->
                            <div class="tab">
                                {% for desc in descriptions %}
                                    <button class="tablinks {% if forloop.first %}active{% endif %}" onclick="openTab(event, '{{ type }}-{{ forloop.counter }}')">{{ desc.model }}</button>
                                {% endfor %}
                            </div>
                            {% for desc in descriptions %}
                                <div id="{{ type }}-{{ forloop.counter }}" class="tabcontent {% if forloop.first %}active{% endif %}">
                                    <p>{{ desc.description|markdownify }}</p>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
    {% else %}
        <p>No descriptions available for this microbe.</p>
    {% endif %}
    </div>

    <!-- Phenotypes and Predictions Table -->
    <div class="section full-width-section">
        <h2>Phenotypes and Predictions</h2>
        <div class="table-description">
            <p>The table shows the phenotypes and predictions. Cell colors indicate the class of the value. When literature-based data is available, a checkmark (✓) indicates a correct prediction, while an ✗ indicates an incorrect prediction.</p>
        </div>

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <p style="margin: 0;">
                <span class="phenotype-high-quality">Literature-based phenotypes: {{ ground_truth_count }}</span>
            </p>
            <p style="margin: 0;">
                <span class="phenotype-generated">LLM predicted phenotypes: {{ additional_predictions_count }}</span>
            </p>
        </div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Phenotype</th>
                        <th class="ground-truth-column">High-quality annotation</th>
                        {% for prediction in phenotype_data.0.predictions %}
                            <th>
                                <a href="{% url 'model_detail' model_name=prediction.model|urlencode %}">
                                    {{ prediction.model }}
                                </a>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for data in phenotype_data %}
                        {% if data.phenotype_definition.name != "Member of WA subset" %}
                            <tr>
                                <td>
                                    <a href="{% url 'model_ranking' %}#{{ data.phenotype_definition.name|slugify }}">
                                        {{ data.phenotype_definition.name|clean_phenotype }}
                                    </a>
                                </td>
                                <td class="ground-truth-column {% if data.ground_truth|default:'N/A'|lower == 'n/a' %}na-cell{% endif %}" style="
                                    background-color: {{ data.ground_truth|default:'N/A'|consistent_color }};
                                    color: black;
                                ">
                                    {% if data.ground_truth|default:'N/A'|lower == 'n/a' %}
                                        <span class="monospace">N/A</span>
                                    {% else %}
                                        <span class="monospace">{{ data.ground_truth|clean_quotes }}</span>
                                    {% endif %}
                                </td>
                                {% for prediction in data.predictions %}
                                <td class="{% if prediction.predicted_value|default:'N/A'|lower == 'n/a' %}na-cell{% endif %}" style="
                                    background-color: {{ prediction.predicted_value|default:'N/A'|consistent_color }};
                                    color: black;
                                ">
                                    {% if prediction.predicted_value|default:'N/A'|lower != 'n/a' %}
                                        <span class="monospace">{{ prediction.predicted_value|clean_quotes }}</span>
                                        {% if data.ground_truth %}
                                            {% if prediction.predicted_value|normalize_value == data.ground_truth|normalize_value %}
                                                <span style="margin-left: 5px; color: green;">✓</span>
                                            {% else %}
                                                <span style="margin-left: 5px; color: red;">✗</span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <span class="monospace">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                        {% endif %}
                    {% empty %}
                        <tr>
                            <td colspan="{{ 2|add:phenotype_data.0.predictions|length }}">No phenotypes available</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p><a href="{% url 'index' %}">Back to Search</a></p>

    <script>
        function openTab(evt, tabName) {
            // Existing openTab function for other descriptions
            var tabcontent = document.getElementsByClassName("tabcontent");
            for (var i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove('active');
            }
            
            var tablinks = evt.currentTarget.parentNode.getElementsByTagName("button");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            var currentTab = document.getElementById(tabName);
            if (currentTab) {
                currentTab.style.display = "block";
                currentTab.classList.add('active');
            }
            evt.currentTarget.classList.add("active");
        }

        function openGeneralInfoTab(evt, tabName) {
            // Get all elements with class="tabcontent" in General Information and hide them
            var tabcontents = document.querySelectorAll('.section.full-width-section .tabcontent');
            tabcontents.forEach(function(content) {
                content.style.display = "none";
                content.classList.remove('active');
            });

            var tablinks = evt.currentTarget.parentNode.getElementsByTagName("button");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            var currentTab = document.getElementById(tabName);
            if (currentTab) {
                currentTab.style.display = "block";
                currentTab.classList.add('active');
            }
            evt.currentTarget.classList.add("active");
        }

        // Initialize the first tab as active for all tab sections
        document.addEventListener('DOMContentLoaded', function() {
            var activeTabs = document.querySelectorAll('.tabcontent.active');
            activeTabs.forEach(function(tab) {
                tab.style.display = "block";
            });
        });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('accessChart').getContext('2d');
        const accessChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ daily_dates|safe }},
                datasets: [{
                    data: {{ daily_access_counts|safe }},
                    borderColor: 'rgba(7, 69, 173, 1)',
                    backgroundColor: 'rgba(204, 204, 204, 0.5)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: true,
                    tension: 0.4,
                    clip: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                scales: {
                    x: {
                        display: false,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        display: false,
                        grid: {
                            display: false
                        },
                        beginAtZero: true,
                        suggestedMax: Math.max(...{{ daily_access_counts|safe }}, 1)
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                    enabled: false
                }
            }
        });
    });
</script>
<!-- End of Chart.js Script -->
    
{% endblock %}

