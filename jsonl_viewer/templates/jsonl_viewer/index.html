{% extends "jsonl_viewer/base.html" %}
{% load custom_filters %}

{% block title %}Welcome to microbe.cards{% endblock %}

{% block extra_head %}
<link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
<style>
    .phenotype-available {
        background-color: #d4edda; /* Light green */
    }
    .phenotype-missing {
        background-color: #f8d7da; /* Light red */
    }
    .phenotype-predicted {
        background-color: #d0e7ff; /* Light blue */
    }
    .phenotype-both {
        background-color: #c3e6cb; /* Greenish */
    }
    .phenotype-high-quality {
        background-color: #c3e6cb; /* Greenish */
        color: #155724; /* Dark green text */
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
    }
    .phenotype-generated {
        background-color: #d0e7ff; /* Light blue */
        color: #155724; /* Dark green text */
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
    }
    .dashboard {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        margin: 20px 0;
    }
    .dashboard-box {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin: 10px;
        flex: 1 1 200px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .dashboard-box h2 {
        font-size: 1.2em;
        margin-bottom: 10px;
        color: #555;
    }
    .dashboard-box p {
        font-size: 2.5em;
        font-weight: bold;
        margin: 0;
        color: #333;
    }
    .search-box-container {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        margin: 40px auto;
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .search-description {
        margin-bottom: 15px;
        font-size: 1.1em;
        color: #555;
        text-align: center;
    }

    .search-form {
        display: flex;
        width: 100%;
        gap: 10px;
    }

    .search-input {
        flex: 1;
        height: 50px;
        font-size: 1.2em;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .search-button {
        height: 50px;
        padding: 0 20px;
        font-size: 1.2em;
        background-color: #4285F4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .search-button:hover {
        background-color: #3367D6;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .search-form {
            flex-direction: column;
        }

        .search-button {
            width: 100%;
        }
    }

    .results-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .results-table th, .results-table td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
    }
    .results-table th {
        background-color: #f2f2f2;
        text-decoration: none;
        color: inherit;
        cursor: default;
    }
    .phenotype-filters {
        margin: 20px 0;
    }
    .phenotype-filter-list {
        list-style-type: none;
        padding: 0;
    }
    .phenotype-filter-item {
        margin-bottom: 10px;
    }
    .phenotype-filter-item > a {
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        color: #007bff;
    }
    .phenotype-values {
        margin-left: 20px;
        list-style-type: none;
        padding: 0;
    }
    .phenotype-values li {
        margin-bottom: 5px;
    }
    .phenotype-values li a {
        cursor: pointer;
        text-decoration: none;
        color: #007bff;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .loading-overlay .spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 8px solid #f3f3f3;
        border-top: 8px solid #333;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .phenotype-table {
        font-size: 0.8em;
        margin-top: 5px;
        border-collapse: collapse;
        width: 100%;
    }
    .phenotype-table td {
        padding: 2px 4px;
        border: 1px solid #ddd;
        word-wrap: break-word;
    }
    .phenotype-available {
        background-color: #d4edda;
    }
    .phenotype-missing {
        background-color: #f8d7da;
    }
    .phenotype-header {
        font-weight: bold;
        background-color: #e9ecef;
    }

    /* Microbe of the Day Styles */
    .microbe-of-the-day-title {
        width: 100%;
        text-align: center;
        font-size: 2em;
        margin-bottom: 20px;
        color: #333;
    }

    .microbe-of-the-day {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 30px;
        margin: 30px 0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: row;
        gap: 20px;
        flex-wrap: wrap; /* Allows columns to stack on smaller screens */
    }

    /* Adjusted columns for better layout */
    .left-column {
        flex: 2 1 400px; /* Increased width */
        min-width: 300px;
    }

    .right-column {
        flex: 1 1 250px; /* Reduced width */
        min-width: 250px;
    }

    /* Phenotype Status Overview as a less prominent heading */
    .phenotype-status-overview {
        font-size: 1.5em; /* Reduced size */
        margin-bottom: 15px;
        color: #333;
    }

    /* Phenotype Table adjustments */
    .phenotype-overview-table {
        width: 100%;
        border-collapse: collapse;
    }
    .phenotype-overview-table th, .phenotype-overview-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .phenotype-overview-table th {
        background-color: #f2f2f2;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .microbe-of-the-day {
            flex-direction: column;
        }
    }

    /* Update Phenotype Status Label */
    .phenotype-high-quality {
        background-color: #c3e6cb; /* Greenish */
        color: #155724; /* Dark green text */
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<h1>Welcome to microbe.cards</h1>

<p>This platform represents an effort to synchronize phenotypic information for microbes. We have applied and collected various models, primarily Large Language Model (LLM) based, to predict phenotypes and compare these predictions to high-quality phenotypes documented in scientific literature or phenotyping studies. For each microbe, we've generated a "card" page that collects this information and illustrates how the predictions overlap with ground truth. Additionally, we provide model performance estimates for widely used public LLM models based on these high-quality data. Use the search functionality below to explore these microbe cards and compare predictions with documented phenotypes.</p>

<div class="dashboard">
    <div class="dashboard-box">
        <h2>Total Species with high-quality annotations</h2>
        <p>{{ total_species_with_ground_truth }}</p>
    </div>
    <div class="dashboard-box">
        <h2>Species with Additional AI-based Predictions</h2>
        <p>{{ total_species_with_predictions }}</p>
    </div>
    <div class="dashboard-box">
        <h2>Evaluated Phenotypes</h2>
        <p><a href="{% url 'model_ranking' %}">{{ total_phenotypes }}</a></p>
    </div>
    <div class="dashboard-box">
        <h2>Evaluated Models</h2>
        <p><a href="{% url 'model_ranking' %}">{{ total_models }}</a></p>
    </div>
</div>

<!-- Updated Search Box Section: Moved Above Microbe of the Day -->
<div class="search-box-container">
    <div class="search-description">
        Enter a taxonomy or microbe name to search for detailed information:
    </div>
    <form method="post" id="search-form" class="search-form">
        {% csrf_token %}
        <input type="text" id="search-input" name="search_term" class="search-input" placeholder="Search by taxonomy or microbe name..." value="{{ request.POST.search_term }}">
        <!-- Hidden inputs to preserve state -->
        <input type="hidden" name="selected_phenotype" value="{{ request.POST.selected_phenotype }}">
        <input type="hidden" name="selected_value" value="{{ request.POST.selected_value }}">
        <input type="hidden" name="include_no_predictions" value="{{ include_no_predictions }}">
        <button type="submit" class="search-button">
            <i class="fas fa-search"></i> Search
        </button>
        <button type="button" class="search-button" id="show-example-button">
            <i class="fas fa-lightbulb"></i> Show Example
        </button>
    </form>
</div>


{% if search_results %}
    <h2 class="mt-4">Search Results</h2>
    <table class="results-table">
        <thead>
            <tr>
                <th style="width: 20%; text-align: left;">Species name</th>
                <th style="width: 15%;">Literature-based<br>predictions</th>
                <th style="width: 15%;">LLM-inferred<br>predictions</th>
                <th style="width: 50%;">Available phenotypes (<span class="phenotype-predicted">based on LLMs</span>; <span class="phenotype-available">based on literature</span>; <span class="phenotype-missing">missing</span>)</th>
            </tr>
        </thead>
        <tbody>
            {% for microbe in search_results %}
                <tr>
                    <td style="text-align: left;"><a href="{% url 'microbe_detail' microbe.id %}">{{ microbe.binomial_name }}</a></td>
                    <td>{{ microbe.ground_truth_count }}</td>
                    <td>{{ microbe.additional_predictions_count }}</td>
                    <td>
                        <table class="phenotype-table">
                            <tr>
                                {% for item in microbe.phenotypes_available %}
                                    {% if item.definition.name != "Member of WA subset" %}
                                        <td class="
                                            {% if item.has_gt and item.has_prediction %}
                                                phenotype-both
                                            {% elif item.has_gt %}
                                                phenotype-available
                                            {% elif item.has_prediction %}
                                                phenotype-predicted
                                            {% else %}
                                                phenotype-missing
                                            {% endif %}
                                        ">
                                            {{ item.definition.name|truncatechars:15 }}
                                        </td>
                                        {% if forloop.counter|divisibleby:"5" and not forloop.last %}
                                            </tr><tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        </table>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

     <!-- Move the "Show results with no LLM predictions" link below the results -->
     <div class="include-no-predictions">
        <form method="post" id="include-no-predictions-form">
            {% csrf_token %}
            <!-- Preserve search parameters -->
            <input type="hidden" name="search_term" value="{{ request.POST.search_term }}">
            <input type="hidden" name="selected_phenotype" value="{{ request.POST.selected_phenotype }}">
            <input type="hidden" name="selected_value" value="{{ request.POST.selected_value }}">
            {% if include_no_predictions %}
                <input type="hidden" name="include_no_predictions" value="false">
                <a href="#" onclick="document.getElementById('include-no-predictions-form').submit();">Hide results with no LLM predictions</a>
            {% else %}
                <input type="hidden" name="include_no_predictions" value="true">
                <a href="#" onclick="document.getElementById('include-no-predictions-form').submit();">Show results with no LLM predictions</a>
            {% endif %}
        </form>
    </div>
{% endif %}

<!-- Microbe of the Day Section -->
{% if microbe_of_the_day %}
    <div class="microbe-of-the-day">
        <h2 class="microbe-of-the-day-title">Microbe of the Day: <i>{{ microbe_of_the_day.binomial_name }}</i></h2>
    
        <!-- Left Column: Description -->
        <div class="left-column">
            <div class="microbe-card">
                <!-- Description Section -->
                <div class="description">
                    {{ microbe_of_the_day.description|markdownify }}
                </div>
                <p><a href="{% url 'microbe_detail' microbe_of_the_day.id %}" class="view-details-button">View Card</a></p>
            </div>
        </div>

        <!-- Right Column: Phenotype Status Overview -->
        <div class="right-column">
            <b>Annotation types:</b>
            <table class="phenotype-overview-table">
                <thead>
                    <tr>
                        <th>Phenotype</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for phenotype in microbe_of_the_day.phenotypes_available %}
                        {% if phenotype.definition.name != "Member of WA subset" %}
                            <tr>
                                <td>{{ phenotype.definition.name|truncatechars:25 }}</td>
                                <td>
                                    {% if phenotype.has_gt and phenotype.has_prediction %}
                                        <span class="phenotype-high-quality">Literature-based</span>
                                    {% elif phenotype.has_gt %}
                                        <span class="phenotype-available">Available</span>
                                    {% elif phenotype.has_prediction %}
                                        <span class="phenotype-generated">LLM-based</span>
                                    {% else %}
                                        <span class="phenotype-missing">Missing</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    $(document).ready(function() {
        $("#search-input").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{% url 'taxonomy_autocomplete' %}",
                    dataType: "json",
                    data: {
                        q: request.term,
                    },
                    success: function(data) {
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text + " (" + item.level + ")",
                                value: item.text,
                                level: item.level
                            };
                        }));
                    }
                });
            },
            minLength: 2,
        });

        // Show loading indicator on form submission
        $('#search-form').on('submit', function() {
            $('#loading-overlay').show();
        });

        // Handle "Show Example" button click
        $('#show-example-button').on('click', function() {
            $('#search-input').val('Escherichia');
            $('#search-form').submit();
        });
    });
</script>
{% endblock %}