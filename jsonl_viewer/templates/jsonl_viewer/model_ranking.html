{% extends 'jsonl_viewer/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<style>
    .section {
        margin-bottom: 20px;
    }
    .table-wrapper {
        overflow-x: auto;
    }
    .table-chart-container {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 30px;
    }
    .table-container {
        flex: 1;
        min-width: 300px;
    }
    .chart-container {
        flex: 1;
        min-width: 300px;
        height: 600px;
        background-color: #f9f9f9;
    }
</style>
{% endblock %}

{% block content %}
<h1>Model Rankings</h1>

<div class="phenotype-list">
    <h2>Available Phenotypes</h2>
    <ul>
        {% for phenotype, description in phenotype_descriptions.items %}
            <li><a href="#{{ phenotype|slugify }}"><strong>{{ phenotype }}</strong></a>: {{ description }}</li>
        {% endfor %}
    </ul>
</div>

{% for phenotype, models in rankings.items %}
    <div id="{{ phenotype|slugify }}" class="phenotype-section">
        <h2>{{ phenotype }}</h2>
        <div class="table-chart-container">
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="model-performance-table-{{ phenotype|slugify }}" class="display">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Balanced Accuracy</th>
                                <th>Precision</th>
                                <th>Sample Size</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model, metrics in models.items %}
                                <tr>
                                    <td><a href="{% url 'model_detail' model_name=model %}">{{ model }}</a></td>
                                    <td>{{ metrics.balanced_accuracy|default_if_none:'N/A'|floatformat:3 }}</td>
                                    <td>{{ metrics.precision|default_if_none:'N/A'|floatformat:3 }}</td>
                                    <td>{{ metrics.sample_size }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performance-chart-{{ phenotype|slugify }}"></canvas>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function getHeatmapColor(value, min, max, isLogScale = false) {
    if (isNaN(value)) return 'white';
    if (isLogScale) {
        value = Math.log(value + 1);
        min = Math.log(min + 1);
        max = Math.log(max + 1);
    }
    var ratio = (value - min) / (max - min);
    var hue = (1 - ratio) * 120;
    return 'hsla(' + hue + ', 80%, 80%, 0.5)';
}

$(document).ready(function() {
    {% for phenotype, models in rankings.items %}
        var table{{ phenotype|slugify }} = $('#model-performance-table-{{ phenotype|slugify }}').DataTable({
            order: [[1, 'desc']],
            pageLength: 25,
            createdRow: function(row, data, dataIndex) {
                $('td:eq(1)', row).css('background-color', getHeatmapColor(parseFloat(data[1]), 0.5, 1));
                $('td:eq(2)', row).css('background-color', getHeatmapColor(parseFloat(data[2]), 0.5, 1));
                $('td:eq(3)', row).css('background-color', getHeatmapColor(parseFloat(data[3]), 0, 10000, true));
            }
        });

        var ctx{{ phenotype|slugify }} = document.getElementById('performance-chart-{{ phenotype|slugify }}').getContext('2d');
        var chartData{{ phenotype|slugify }} = {
            labels: [{% for model, metrics in models.items %}'{{ model }}',{% endfor %}],
            datasets: [{
                label: 'Balanced Accuracy',
                data: [{% for model, metrics in models.items %}{{ metrics.balanced_accuracy|default_if_none:'null' }},{% endfor %}],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };
        var myChart{{ phenotype|slugify }} = new Chart(ctx{{ phenotype|slugify }}, {
            type: 'bar',
            data: chartData{{ phenotype|slugify }},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 1
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '{{ phenotype }} - Balanced Accuracy for Each Model'
                    },
                    legend: {
                        display: false
                    }
                },
                layout: {
                    padding: {
                        left: 20,
                        right: 20,
                        top: 0,
                        bottom: 0
                    }
                }
            }
        });
    {% endfor %}
});
</script>
{% endblock %}