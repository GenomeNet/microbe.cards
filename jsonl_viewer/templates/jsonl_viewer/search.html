{% extends "jsonl_viewer/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Search Microbes{% endblock %}

{% block content %}
<h1>Search Microbes</h1>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">Searching microbes...</div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{% url 'search_microbes' %}" id="search-form">
            <!-- Text Search -->
            <div class="mb-3">
                <label for="text_search" class="form-label">Search descriptions</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="text_search" name="text_search" 
                           placeholder="Search in descriptions..." value="{{ request.GET.text_search }}">
                    <button type="button" class="btn btn-outline-secondary" id="reset-search">
                        <i class="fas fa-times"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Search Summary -->
            <div class="mb-3" id="search-summary">
                {% if organized_results %}
                    <div class="alert alert-info">
                        Found {{ result_count }} matches
                        {% if request.GET.text_search %}
                            with text "{{ request.GET.text_search }}"
                        {% endif %}
                        {% if active_filters %}
                            and {{ active_filters|length }} active filter{{ active_filters|length|pluralize }}
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Phenotype Filters -->
            <div class="mb-3">
                <h5>Filter by Phenotypes:</h5>
                <div id="phenotype-filters">
                    <!-- Existing filters will be populated here -->
                    {% for filter in active_filters %}
                        <div class="filter-group mb-2" data-index="{{ forloop.counter0 }}">
                            <div class="input-group">
                                <select class="form-select phenotype-select" name="phenotype_{{ forloop.counter0 }}" required>
                                    <option value="">Select Phenotype</option>
                                    {% for pd in phenotype_definitions %}
                                        <option value="{{ pd.id }}" {% if pd.id|stringformat:"s" == filter.phenotype_id %}selected{% endif %}>
                                            {{ pd.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-danger remove-filter-btn">Remove</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <select class="form-select value-select" name="value_{{ forloop.counter0 }}" style="display: none;" required>
                                    <option value="">Select Value</option>
                                    <!-- Options will be populated via JavaScript -->
                                </select>
                                <input type="text" class="form-control value-input" name="value_{{ forloop.counter0 }}" 
                                       placeholder="Enter value" style="display: none;" required>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary mt-2" id="add-filter-btn">
                    <i class="fas fa-plus"></i> Add Phenotype Filter
                </button>
            </div>
            
            <button type="submit" class="btn btn-primary" id="search-button">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                Search
            </button>
        </form>
    </div>
</div>

<!-- Results section -->
{% if organized_results %}
    <div class="results-section">
        <h2>Search Results <span class="taxonomy-count">({{ result_count }} matches)</span></h2>
        
        <table class="taxonomy-table table table-striped">
            <thead>
                <tr>
                    <th>Superkingdom</th>
                    <th>Phylum</th>
                    <th>Class</th>
                    <th>Order</th>
                    <th>Family</th>
                    <th>Genus</th>
                    <th>Species</th>
                </tr>
            </thead>
            <tbody>
                {% for superkingdom, phyla in organized_results.items %}
                    {% for phylum, microbes in phyla.items %}
                        {% for microbe in microbes %}
                            <tr>
                                <td>{{ superkingdom }}</td>
                                <td>{{ phylum }}</td>
                                <td>{{ microbe.taxonomy.classification.class_name }}</td>
                                <td>{{ microbe.taxonomy.order_name }}</td>
                                <td>{{ microbe.taxonomy.family_name }}</td>
                                <td>{{ microbe.taxonomy.genus_name }}</td>
                                <td><a href="{% url 'microbe_detail' microbe.id %}">{{ microbe.binomial_name }}</a></td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% elif request.GET %}
    <div class="alert alert-info">No results found. Try refining your search criteria.</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
    const phenotypeDefinitions = {{ phenotype_definitions_json|safe }};

    function createPhenotypeFilter(index) {
        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter-group mb-3';

        // Input Group for Phenotype Select and Remove Button
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        const phenotypeSelect = document.createElement('select');
        phenotypeSelect.name = `phenotype_${index}`;
        phenotypeSelect.className = 'form-select phenotype-select';
        phenotypeSelect.required = true;

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'Select Phenotype';
        phenotypeSelect.appendChild(defaultOption);

        phenotypeDefinitions.forEach(pd => {
            const option = document.createElement('option');
            option.value = pd.id;
            option.text = pd.name;
            option.dataset.description = pd.description;
            option.dataset.allowedValues = JSON.stringify(pd.allowed_values);
            option.dataset.dataType = pd.data_type;
            phenotypeSelect.appendChild(option);
        });

        const removeBtnDiv = document.createElement('div');
        removeBtnDiv.className = 'input-group-append';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger remove-filter-btn';
        removeBtn.innerHTML = 'Remove';
        removeBtn.onclick = () => {
            filterDiv.remove();
            submitSearchForm();
        };

        removeBtnDiv.appendChild(removeBtn);
        inputGroup.appendChild(phenotypeSelect);
        inputGroup.appendChild(removeBtnDiv);
        filterDiv.appendChild(inputGroup);

        // Div for Value Select/Input
        const valueDiv = document.createElement('div');
        valueDiv.className = 'mt-2';

        const valueSelect = document.createElement('select');
        valueSelect.name = `value_${index}`;
        valueSelect.className = 'form-select value-select';
        valueSelect.style.display = 'none';
        valueSelect.required = true;

        const valueDefaultOption = document.createElement('option');
        valueDefaultOption.value = '';
        valueDefaultOption.text = 'Select Value';
        valueSelect.appendChild(valueDefaultOption);

        const valueInput = document.createElement('input');
        valueInput.name = `value_${index}`;
        valueInput.className = 'form-control value-input';
        valueInput.placeholder = 'Enter value';
        valueInput.style.display = 'none';
        valueInput.required = true;

        valueDiv.appendChild(valueSelect);
        valueDiv.appendChild(valueInput);
        filterDiv.appendChild(valueDiv);

        // Event listener for phenotype selection
        phenotypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description;
            const dataType = selectedOption.dataset.dataType;
            let allowedValues = [];

            if (selectedOption.dataset.allowedValues) {
                try {
                    allowedValues = JSON.parse(selectedOption.dataset.allowedValues);
                } catch (e) {
                    console.error('Error parsing allowed values:', e);
                }
            }

            // Reset value inputs
            valueSelect.innerHTML = '<option value="">Select Value</option>';
            valueInput.value = '';

            if (dataType === 'boolean') {
                valueSelect.innerHTML = `
                    <option value="">Select Value</option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                `;
                valueSelect.style.display = 'block';
                valueInput.style.display = 'none';
                valueSelect.required = true;
                valueInput.required = false;
            } else if (Array.isArray(allowedValues) && allowedValues.length > 0) {
                allowedValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.text = value;
                    valueSelect.appendChild(option);
                });
                valueSelect.style.display = 'block';
                valueInput.style.display = 'none';
                valueSelect.required = true;
                valueInput.required = false;
            } else {
                valueSelect.style.display = 'none';
                valueInput.style.display = 'block';
                valueSelect.required = false;
                valueInput.required = true;
            }

            submitSearchForm();
        });

        // Event listeners for value selection/input
        valueSelect.addEventListener('change', function() {
            if (this.value) {
                submitSearchForm();
            }
        });

        valueInput.addEventListener('input', function() {
            if (this.value.trim()) {
                submitSearchForm();
            }
        });

        return filterDiv;
    }

    document.getElementById('add-filter-btn').addEventListener('click', () => {
        const filtersDiv = document.getElementById('phenotype-filters');
        const filterCount = filtersDiv.children.length;
        const newFilter = createPhenotypeFilter(filterCount);
        filtersDiv.appendChild(newFilter);
    });

    // Re-populate existing filters
    document.addEventListener('DOMContentLoaded', () => {
        const filtersDiv = document.getElementById('phenotype-filters');
        const urlParams = new URLSearchParams(window.location.search);
        let index = 0;

        while (urlParams.has(`phenotype_${index}`)) {
            const phenotypeId = urlParams.get(`phenotype_${index}`);
            const value = urlParams.get(`value_${index}`);

            const newFilter = createPhenotypeFilter(index);
            filtersDiv.appendChild(newFilter);

            const phenotypeSelect = newFilter.querySelector('.phenotype-select');
            phenotypeSelect.value = phenotypeId;
            phenotypeSelect.dispatchEvent(new Event('change'));

            const valueSelect = newFilter.querySelector('.value-select');
            const valueInput = newFilter.querySelector('.value-input');

            if (valueSelect.style.display !== 'none') {
                valueSelect.value = value;
            } else {
                valueInput.value = value;
            }

            index++;
        }
    });

    // Update the reset search functionality
    document.getElementById('reset-search').addEventListener('click', () => {
        document.getElementById('text_search').value = '';
        document.getElementById('phenotype-filters').innerHTML = '';
        window.location.href = '{% url "search_microbes" %}';
    });

    function toggleLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = show ? 'flex' : 'none';
    }

    function submitSearchForm() {
        const form = document.getElementById('search-form');

        // Remove any duplicate value parameters
        const seenNames = new Set();
        form.querySelectorAll('input, select').forEach(element => {
            if (element.name && element.name.startsWith('value_')) {
                if (seenNames.has(element.name)) {
                    element.remove();
                } else {
                    seenNames.add(element.name);
                }
            }
        });

        toggleLoading(true);
        form.submit();
    }

    // Add form submit handler
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitSearchForm();
    });

    // Hide loading overlay when page loads
    window.addEventListener('load', function() {
        toggleLoading(false);
    });

    // Hide loading overlay when using browser back/forward
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            toggleLoading(false);
        }
    });
</script>
{% endblock %}